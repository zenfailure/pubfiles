#!/bin/bash

usage() {
    echo "$0 [ -r ] [ -s session-name ] [ ssh-host ]"
    exit 1
}

DIR="$(cd "$( dirname "${BASH_SOURCE[0]}"  )" >/dev/null 2>&1 && pwd)"

run="~/.tmux/bin/mrun"

session="mux/$(whoami)/$(hostname)"

parse_host() {
    host="$1"
    rem_username=$(ssh -G "$host" | grep '^user ' | awk '{print $2}')
    rem_hostname=$(ssh -G "$host" | grep '^hostname ' | awk '{print $2}')
    rem_hostname=$(echo "$rem_hostname" | sed -nr 's|(.*\.)*(.+)\.[[:alnum:]]+$|\2|p')
    rem_session="r/$session/$rem_username/$rem_hostname"
    echo "$rem_session"
}

main() {
    while getopts ":hs:" opt; do
        case $opt in
            s)
                session="$OPTARG"
                ;;
            h)
                usage
                ;;
            r)
                remove=1
                ;;
            \?)
                echo "Invalid option: $OPTARG" 1>&2
                usage
                ;;
            :)
                echo "Invalid option: $OPTARG requires an argument" 1>&2
                usage
                ;;
        esac
    done
    shift $((OPTIND - 1))

    if [[ "$TERM" = linux  && $(tty) =~ /dev/pts/.* ]]; then
        PRE='TERM=fbterm'
    fi

    local host="$1"
    if [[ -z "$host" ]]; then
        lvmux
    else
        session=$(parse_host "$host")
        rvmux
    fi
    exit 0
}

lvmux() {
    if tmux has-session -t "$session" &>/dev/null ; then
        eval $PRE exec tmux attach-session -t "$session"
    else
        eval $PRE exec tmux new-session -s "$session"
    fi
}

rvmux() {
    remcmd="~/.tmux/bin/vmux -s $session"

    sshcmd="ssh -t $host $remcmd"

    if tmux has-session -t "$session" &>/dev/null; then
        exec tmux attach-session -t "$session"
    else
        tmux new-session -d -s "$session" "$sshcmd"
        tmux run "$run switch_sendkeys_mode"
        exec tmux attach-session -t "$session"
    fi
}

main "$@"
